name: Build & Deploy to K3s (TVA)

on:
  push:
    branches: [ "deploy" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      BACKEND_IMAGE: ghcr.io/life-00/byo-tva-backend
      FRONTEND_IMAGE: ghcr.io/life-00/byo-tva-frontend
      K8S_DIR: infra/k8s/application
      BACKEND_YAML: 05-backend.yaml
      FRONTEND_YAML: 06-frontend.yaml

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate version tag
        id: version
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          SHA=$(git rev-parse --short=7 HEAD)
          echo "version_tag=${TS}-${SHA}" >> "$GITHUB_OUTPUT"
          echo "VERSION_TAG=${TS}-${SHA}" >> "$GITHUB_ENV"

      - name: Build & Push Backend
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "${BACKEND_IMAGE}:${VERSION_TAG}" \
            -t "${BACKEND_IMAGE}:latest" \
            --push ./backend

      - name: Build & Push Frontend
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "${FRONTEND_IMAGE}:${VERSION_TAG}" \
            -t "${FRONTEND_IMAGE}:latest" \
            --push ./frontend

      # ====== 여기부터는 '자동 배포' 단계인데, 먼저 Secrets가 필요함 ======
      # Settings > Secrets and variables > Actions 에 아래 2개 등록 필요
      # - EC2_HOST : EC2 공인 IP 또는 도메인
      # - EC2_SSH_KEY : pem 내용 전체(-----BEGIN ... 포함)
      - name: Deploy on K3s (EC2)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            cd /home/ubuntu/deploy/ByO-Target-Platform-Hackathon

            git checkout deploy || true
            git pull --ff-only origin deploy

            cd "${K8S_DIR}"

            # 이미지 태그를 새 버전으로 교체
            sed -i "s|image: ${BACKEND_IMAGE}:.*|image: ${BACKEND_IMAGE}:${VERSION_TAG}|g" "${BACKEND_YAML}"
            sed -i "s|image: ${FRONTEND_IMAGE}:.*|image: ${FRONTEND_IMAGE}:${VERSION_TAG}|g" "${FRONTEND_YAML}"

            kubectl -n tva apply -f "${BACKEND_YAML}"
            kubectl -n tva apply -f "${FRONTEND_YAML}"

            kubectl -n tva rollout status deploy/backend --timeout=180s
            kubectl -n tva rollout status deploy/frontend --timeout=180s
