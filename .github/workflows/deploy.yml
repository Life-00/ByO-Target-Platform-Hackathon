name: Build & Deploy to K3s (TVA)

on:
  push:
    branches: [ "deploy" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      # ===== 고정 이미지 prefix (요청사항) =====
      # 결과 이미지:
      # - ghcr.io/life-00/byo-tva-backend:<tag>
      # - ghcr.io/life-00/byo-tva-frontend:<tag>
      IMAGE_PREFIX: ghcr.io/life-00/byo-tva

      # ===== K8s manifest 경로/파일 (현재 repo 구조 기준) =====
      K8S_DIR: infra/k8s/application
      BACKEND_YAML: 05-backend.yaml
      FRONTEND_YAML: 06-frontend.yaml
      NAMESPACE: tva

      # ===== EC2에 클론된 repo 경로 (현재 너희 운영 경로 기준) =====
      REPO_DIR: /home/ubuntu/deploy/ByO-Target-Platform-Hackathon

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 버전 태그: UTC timestamp + short sha
      - name: Generate version tag
        id: version
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          SHA=$(git rev-parse --short=7 HEAD)
          VERSION_TAG="${TS}-${SHA}"
          echo "version_tag=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "VERSION_TAG=${VERSION_TAG}" >> "$GITHUB_ENV"
          echo "Generated VERSION_TAG=${VERSION_TAG}"

      - name: Build & Push Backend (multi-arch)
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "${IMAGE_PREFIX}-backend:${VERSION_TAG}" \
            -t "${IMAGE_PREFIX}-backend:latest" \
            --push ./backend

      - name: Build & Push Frontend (multi-arch)
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "${IMAGE_PREFIX}-frontend:${VERSION_TAG}" \
            -t "${IMAGE_PREFIX}-frontend:latest" \
            --push ./frontend

      # ===== Deploy 단계 =====
      # Repo Secrets 필요:
      # - EC2_HOST: EC2 공인 IP 또는 도메인
      # - EC2_SSH_KEY: pem 내용 전체(-----BEGIN ... 포함)
      - name: Deploy on K3s (EC2)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            # === EC2에서 사용할 값들 (여기서 직접 정의해야 unbound 방지) ===
            REPO_DIR="${{ env.REPO_DIR }}"
            K8S_DIR="${{ env.K8S_DIR }}"
            BACKEND_YAML="${{ env.BACKEND_YAML }}"
            FRONTEND_YAML="${{ env.FRONTEND_YAML }}"
            NAMESPACE="${{ env.NAMESPACE }}"

            IMAGE_PREFIX="${{ env.IMAGE_PREFIX }}"
            VERSION_TAG="${{ env.VERSION_TAG }}"

            cd "$REPO_DIR"

            # deploy 브랜치 최신화
            git fetch --all
            git checkout deploy || git checkout -b deploy
            git pull --ff-only origin deploy

            cd "$K8S_DIR"

            echo "Deploying images with tag: ${VERSION_TAG}"
            echo "Backend image: ${IMAGE_PREFIX}-backend:${VERSION_TAG}"
            echo "Frontend image: ${IMAGE_PREFIX}-frontend:${VERSION_TAG}"

            # YAML 내 image 라인을 새 태그로 교체
            sed -i "s|image: ${IMAGE_PREFIX}-backend:.*|image: ${IMAGE_PREFIX}-backend:${VERSION_TAG}|g" "$BACKEND_YAML" || true
            sed -i "s|image: ${IMAGE_PREFIX}-frontend:.*|image: ${IMAGE_PREFIX}-frontend:${VERSION_TAG}|g" "$FRONTEND_YAML" || true

            # 과거에 고정 경로(ghcr.io/life-00/byo-tva-xxx)를 쓰던 경우까지 커버
            sed -i "s|image: ghcr.io/.*/byo-tva-backend:.*|image: ${IMAGE_PREFIX}-backend:${VERSION_TAG}|g" "$BACKEND_YAML" || true
            sed -i "s|image: ghcr.io/.*/byo-tva-frontend:.*|image: ${IMAGE_PREFIX}-frontend:${VERSION_TAG}|g" "$FRONTEND_YAML" || true

            # 적용
            kubectl -n "$NAMESPACE" apply -f "$BACKEND_YAML"
            kubectl -n "$NAMESPACE" apply -f "$FRONTEND_YAML"

            # 롤아웃 확인
            kubectl -n "$NAMESPACE" rollout status deploy/backend --timeout=240s
            kubectl -n "$NAMESPACE" rollout status deploy/frontend --timeout=240s

            echo "✅ Deployment finished."

